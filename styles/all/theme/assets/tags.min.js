jQuery.fn.caret=function(t){var e=this[0],i="true"===e.contentEditable;if(0==arguments.length){if(window.getSelection)return i?(e.focus(),(n=(a=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(e),n.setEnd(a.endContainer,a.endOffset),n.toString().length):e.selectionStart;if(document.selection){if(e.focus(),i){var a=document.selection.createRange();return(n=document.body.createTextRange()).moveToElementText(e),n.setEndPoint("EndToEnd",a),n.text.length}t=0;var n,r=e.createTextRange(),o=(n=document.selection.createRange().duplicate()).getBookmark();for(r.moveToBookmark(o);0!==r.moveStart("character",-1);)t++;return t}return e.selectionStart?e.selectionStart:0}return-1==t&&(t=this[i?"text":"val"]().length),window.getSelection?i?(e.focus(),window.getSelection().collapse(e.firstChild,t)):e.setSelectionRange(t,t):document.body.createTextRange&&(i?((r=document.body.createTextRange()).moveToElementText(e),r.moveStart("character",t),r.collapse(!0),r.select()):((r=e.createTextRange()).move("character",t),r.select())),i||e.focus(),t},function(t){t.fn.tagEditorInput=function(){var e=" ",i=t(this),a=parseInt(i.css("fontSize")),n=t("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"});return n.insertAfter(i),i.bind("keyup keydown focus",function(){if(e!==(e=i.val())){n.text(e);var t=n.width()+a;20>t&&(t=20),t!=i.width()&&i.width(t)}})},t.fn.tagEditor=function(e,a,n){function r(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var o,l=t.extend({},t.fn.tagEditor.defaults,e);if(l.dregex=new RegExp("["+l.delimiter.replace("-","-")+"]","g"),"string"==typeof e){var c=[];return this.each(function(){var i=t(this),r=i.data("options"),o=i.next(".tag-editor");if("getTags"==e)c.push({field:i[0],editor:o,tags:o.data("tags")});else if("addTag"==e){if(r.maxTags&&o.data("tags").length>=r.maxTags)return!1;t('<li><div class="tag-editor-spacer">&nbsp;'+r.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(o).find(".tag-editor-tag").html('<input type="text" maxlength="'+r.maxLength+'">').addClass("active").find("input").val(a).blur(),n?t(".placeholder",o).remove():o.click()}else"removeTag"==e?(t(".tag-editor-tag",o).filter(function(){return t(this).text()==a}).closest("li").find(".tag-editor-delete").click(),n||o.click()):"destroy"==e&&i.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==e?c:this}return window.getSelection&&t(document).off("keydown.tag-editor").on("keydown.tag-editor",function(e){if(8==e.which||46==e.which||e.ctrlKey&&88==e.which){try{var a=getSelection(),n="INPUT"!=document.activeElement.tagName?t(a.getRangeAt(0).startContainer.parentNode).closest(".tag-editor"):0}catch(e){n=0}if(a.rangeCount>0&&n&&n.length){var r=[],o=a.toString().split(n.prev().data("options").dregex);for(i=0;i<o.length;i++){var l=t.trim(o[i]);l&&r.push(l)}return t(".tag-editor-tag",n).each(function(){~t.inArray(t(this).text(),r)&&t(this).closest("li").find(".tag-editor-delete").click()}),!1}}}),this.each(function(){function e(){!l.placeholder||c.length||t(".deleted, .placeholder, input",s).length||s.append('<li class="placeholder"><div>'+l.placeholder+"</div></li>")}function i(i){var a=c.toString();c=t(".tag-editor-tag:not(.deleted)",s).map(function(e,i){var a=t.trim(t(this).hasClass("active")?t(this).find("input").val():t(i).text());return a||void 0}).get(),s.data("tags",c),n.val(c.join(l.delimiter[0])),i||a!=c.toString()&&l.onChange(n,s,c),e()}function a(e){for(var a,o=e.closest("li"),d=e.val().replace(/ +/," ").split(l.dregex),g=e.data("old_tag"),f=c.slice(0),u=!1,h=0;h<d.length;h++)if(v=t.trim(d[h]).slice(0,l.maxLength),l.forceLowercase&&(v=v.toLowerCase()),a=l.beforeTagSave(n,s,f,g,v),v=a||v,!1!==a&&v&&(l.removeDuplicates&&~t.inArray(v,f)&&t(".tag-editor-tag",s).each(function(){t(this).text()==v&&t(this).closest("li").remove()}),f.push(v),o.before('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+r(v)+'</div><div class="tag-editor-delete"><i></i></div></li>'),l.maxTags&&f.length>=l.maxTags)){u=!0;break}e.attr("maxlength",l.maxLength).removeData("old_tag").val(""),u?e.blur():e.focus(),i()}var n=t(this),c=[],s=t("<ul "+(l.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(n);n.addClass("tag-editor-hidden-src").data("options",l).on("focus.tag-editor",function(){s.click()}),s.append('<li style="width:1px">&nbsp;</li>');var d,g,f='<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';s.click(function(e,i){var a,n,r=99999;if(!window.getSelection||""==getSelection())return l.maxTags&&s.data("tags").length>=l.maxTags?(s.find("input").blur(),!1):(o=!0,t("input:focus",s).blur(),!!o&&(o=!0,t(".placeholder",s).remove(),i&&i.length?n="before":t(".tag-editor-tag",s).each(function(){var o=t(this),l=o.offset(),c=l.left,s=l.top;e.pageY>=s&&e.pageY<=s+o.height()&&(e.pageX<c?(n="before",a=c-e.pageX):(n="after",a=e.pageX-c-o.width()),r>a&&(r=a,i=o))}),"before"==n?t(f).insertBefore(i.closest("li")).find(".tag-editor-tag").click():"after"==n?t(f).insertAfter(i.closest("li")).find(".tag-editor-tag").click():t(f).appendTo(s).find(".tag-editor-tag").click(),!1))}),s.on("click",".tag-editor-delete",function(){if(t(this).prev().hasClass("active"))return t(this).closest("li").find("input").caret(-1),!1;var a=t(this).closest("li"),r=a.find(".tag-editor-tag");return!1!==l.beforeTagDelete(n,s,c,r.text())&&(r.addClass("deleted").animate({width:0},l.animateDelete,function(){a.remove(),e()}),i(),!1)}),l.clickDelete&&s.on("mousedown",".tag-editor-tag",function(a){if(a.ctrlKey||a.which>1){var r=t(this).closest("li"),o=r.find(".tag-editor-tag");return!1!==l.beforeTagDelete(n,s,c,o.text())&&(o.addClass("deleted").animate({width:0},l.animateDelete,function(){r.remove(),e()}),i(),!1)}}),s.on("click",".tag-editor-tag",function(e){if(l.clickDelete&&(e.ctrlKey||e.which>1))return!1;if(!t(this).hasClass("active")){var i=t(this).text(),a=Math.abs((t(this).offset().left-e.pageX)/t(this).width()),n=parseInt(i.length*a),o=t(this).html('<input type="text" maxlength="'+l.maxLength+'" value="'+r(i)+'">').addClass("active").find("input");if(o.data("old_tag",i).tagEditorInput().focus().caret(n),l.autocomplete){var c=t.extend({},l.autocomplete),d="select"in c?l.autocomplete.select:"";c.select=function(e,i){d&&d(e,i),setTimeout(function(){s.trigger("click",[t(".active",s).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},o.autocomplete(c)}}return!1}),s.on("blur","input",function(d){d.stopPropagation();var g=t(this),f=g.data("old_tag"),u=t.trim(g.val().replace(/ +/," ").replace(l.dregex,l.delimiter[0]));if(u){if(u.indexOf(l.delimiter[0])>=0)return void a(g);if(u!=f)if(l.forceLowercase&&(u=u.toLowerCase()),cb_val=l.beforeTagSave(n,s,c,f,u),u=cb_val||u,!1===cb_val){if(f)return g.val(f).focus(),o=!1,void i();try{g.closest("li").remove()}catch(d){}f&&i()}else l.removeDuplicates&&t(".tag-editor-tag:not(.active)",s).each(function(){t(this).text()==u&&t(this).closest("li").remove()})}else{if(f&&!1===l.beforeTagDelete(n,s,c,f))return g.val(f).focus(),o=!1,void i();try{g.closest("li").remove()}catch(d){}f&&i()}g.parent().html(r(u)).removeClass("active"),u!=f&&i(),e()}),s.on("paste","input",function(){t(this).removeAttr("maxlength"),d=t(this),setTimeout(function(){a(d)},30)}),s.on("keypress","input",function(e){l.delimiter.indexOf(String.fromCharCode(e.which))>=0&&(g=t(this),setTimeout(function(){a(g)},20))}),s.on("keydown","input",function(e){var i=t(this);if((37==e.which||!l.autocomplete&&38==e.which)&&!i.caret()||8==e.which&&!i.val())return(a=i.closest("li").prev("li").find(".tag-editor-tag")).length?a.click().find("input").caret(-1):!i.val()||l.maxTags&&s.data("tags").length>=l.maxTags||t(f).insertBefore(i.closest("li")).find(".tag-editor-tag").click(),!1;if((39==e.which||!l.autocomplete&&40==e.which)&&i.caret()==i.val().length)return(r=i.closest("li").next("li").find(".tag-editor-tag")).length?r.click().find("input").caret(0):i.val()&&s.click(),!1;if(9==e.which){if(e.shiftKey){var a;if((a=i.closest("li").prev("li").find(".tag-editor-tag")).length)a.click().find("input").caret(0);else{if(!i.val()||l.maxTags&&s.data("tags").length>=l.maxTags)return n.attr("disabled","disabled"),void setTimeout(function(){n.removeAttr("disabled")},30);t(f).insertBefore(i.closest("li")).find(".tag-editor-tag").click()}return!1}var r;if((r=i.closest("li").next("li").find(".tag-editor-tag")).length)r.click().find("input").caret(0);else{if(!i.val())return;s.click()}return!1}if(!(46!=e.which||t.trim(i.val())&&i.caret()!=i.val().length))return(r=i.closest("li").next("li").find(".tag-editor-tag")).length?r.click().find("input").caret(0):i.val()&&s.click(),!1;if(13==e.which)return s.trigger("click",[i.closest("li").next("li").find(".tag-editor-tag")]),l.maxTags&&s.data("tags").length>=l.maxTags&&s.find("input").blur(),!1;if(36!=e.which||i.caret()){if(35==e.which&&i.caret()==i.val().length)s.find(".tag-editor-tag").last().click();else if(27==e.which)return i.val(i.data("old_tag")?i.data("old_tag"):"").blur(),!1}else s.find(".tag-editor-tag").first().click()});for(var u=l.initialTags.length?l.initialTags:n.val().split(l.dregex),h=0;h<u.length&&!(l.maxTags&&h>=l.maxTags);h++){var v=t.trim(u[h].replace(/ +/," "));v&&(l.forceLowercase&&(v=v.toLowerCase()),c.push(v),s.append('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+r(v)+'</div><div class="tag-editor-delete"><i></i></div></li>'))}i(!0),l.sortable&&t.fn.sortable&&s.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){i()}})})},t.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery),function(t,e,i,a){"use strict";t(i).ready(function(){t(".tag-editor").each(function(){t(this).tagEditor({maxTags:t(this).data("maxTags"),autocomplete:{source:e.tag_search_url,minLength:3}})})})}(jQuery,window,document);