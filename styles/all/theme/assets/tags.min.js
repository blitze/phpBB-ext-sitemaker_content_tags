jQuery.fn.caret=function(t){var e=this[0],i="true"===e.contentEditable;if(0!=arguments.length)return-1==t&&(t=this[i?"text":"val"]().length),window.getSelection?i?(e.focus(),window.getSelection().collapse(e.firstChild,t)):e.setSelectionRange(t,t):document.body.createTextRange&&(i?((r=document.body.createTextRange()).moveToElementText(e),r.moveStart("character",t),r.collapse(!0)):(r=e.createTextRange()).move("character",t),r.select()),i||e.focus(),t;if(window.getSelection)return i?(e.focus(),(n=(a=window.getSelection().getRangeAt(0)).cloneRange()).selectNodeContents(e),n.setEnd(a.endContainer,a.endOffset),n.toString().length):e.selectionStart;if(document.selection){if(e.focus(),i){var a=document.selection.createRange();return(n=document.body.createTextRange()).moveToElementText(e),n.setEndPoint("EndToEnd",a),n.text.length}t=0;var n,r=e.createTextRange(),o=(n=document.selection.createRange().duplicate()).getBookmark();for(r.moveToBookmark(o);0!==r.moveStart("character",-1);)t++;return t}return e.selectionStart?e.selectionStart:0},function(m){m.fn.tagEditorInput=function(){var e=" ",i=m(this),a=parseInt(i.css("fontSize")),n=m("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"});return n.insertAfter(i),i.bind("keyup keydown focus",function(){if(e!==(e=i.val())){n.text(e);var t=n.width()+a;t<20&&(t=20),t!=i.width()&&i.width(t)}})},m.fn.tagEditor=function(a,n,r){function h(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var v,p=m.extend({},m.fn.tagEditor.defaults,a);if(p.dregex=new RegExp("["+p.delimiter.replace("-","-")+"]","g"),"string"!=typeof a)return window.getSelection&&m(document).off("keydown.tag-editor").on("keydown.tag-editor",function(t){if(8==t.which||46==t.which||t.ctrlKey&&88==t.which){try{var e=getSelection(),a="INPUT"!=document.activeElement.tagName?m(e.getRangeAt(0).startContainer.parentNode).closest(".tag-editor"):0}catch(t){a=0}if(0<e.rangeCount&&a&&a.length){var n=[],r=e.toString().split(a.prev().data("options").dregex);for(i=0;i<r.length;i++){var o=m.trim(r[i]);o&&n.push(o)}return m(".tag-editor-tag",a).each(function(){~m.inArray(m(this).text(),n)&&m(this).closest("li").find(".tag-editor-delete").click()}),!1}}}),this.each(function(){function n(){!p.placeholder||d.length||m(".deleted, .placeholder, input",g).length||g.append('<li class="placeholder"><div>'+p.placeholder+"</div></li>")}function c(t){var e=d.toString();d=m(".tag-editor-tag:not(.deleted)",g).map(function(t,e){var i=m.trim(m(this).hasClass("active")?m(this).find("input").val():m(e).text());return i||void 0}).get(),g.data("tags",d),s.val(d.join(p.delimiter[0])),t||e!=d.toString()&&p.onChange(s,g,d),n()}function r(t){for(var e,i=t.closest("li"),a=t.val().replace(/ +/," ").split(p.dregex),n=t.data("old_tag"),r=d.slice(0),o=!1,l=0;l<a.length;l++)if(u=m.trim(a[l]).slice(0,p.maxLength),p.forceLowercase&&(u=u.toLowerCase()),e=p.beforeTagSave(s,g,r,n,u),u=e||u,!1!==e&&u&&(p.removeDuplicates&&~m.inArray(u,r)&&m(".tag-editor-tag",g).each(function(){m(this).text()==u&&m(this).closest("li").remove()}),r.push(u),i.before('<li><div class="tag-editor-spacer">&nbsp;'+p.delimiter[0]+'</div><div class="tag-editor-tag">'+h(u)+'</div><div class="tag-editor-delete"><i></i></div></li>'),p.maxTags&&r.length>=p.maxTags)){o=!0;break}t.attr("maxlength",p.maxLength).removeData("old_tag").val(""),o?t.blur():t.focus(),c()}var s=m(this),d=[],g=m("<ul "+(p.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(s);s.addClass("tag-editor-hidden-src").data("options",p).on("focus.tag-editor",function(){g.click()}),g.append('<li style="width:1px">&nbsp;</li>');var t,e,f='<li><div class="tag-editor-spacer">&nbsp;'+p.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';g.click(function(n,r){var o,l,c=99999;if(!window.getSelection||""==getSelection())return p.maxTags&&g.data("tags").length>=p.maxTags?g.find("input").blur():(v=!0,m("input:focus",g).blur(),v&&(v=!0,m(".placeholder",g).remove(),r&&r.length?l="before":m(".tag-editor-tag",g).each(function(){var t=m(this),e=t.offset(),i=e.left,a=e.top;n.pageY>=a&&n.pageY<=a+t.height()&&((o=n.pageX<i?(l="before",i-n.pageX):(l="after",n.pageX-i-t.width()))<c&&(c=o,r=t))}),"before"==l?m(f).insertBefore(r.closest("li")).find(".tag-editor-tag").click():"after"==l?m(f).insertAfter(r.closest("li")).find(".tag-editor-tag").click():m(f).appendTo(g).find(".tag-editor-tag").click())),!1}),g.on("click",".tag-editor-delete",function(){if(m(this).prev().hasClass("active"))return m(this).closest("li").find("input").caret(-1),!1;var t=m(this).closest("li"),e=t.find(".tag-editor-tag");return!1===p.beforeTagDelete(s,g,d,e.text())||(e.addClass("deleted").animate({width:0},p.animateDelete,function(){t.remove(),n()}),c()),!1}),p.clickDelete&&g.on("mousedown",".tag-editor-tag",function(t){if(t.ctrlKey||1<t.which){var e=m(this).closest("li"),i=e.find(".tag-editor-tag");return!1===p.beforeTagDelete(s,g,d,i.text())||(i.addClass("deleted").animate({width:0},p.animateDelete,function(){e.remove(),n()}),c()),!1}}),g.on("click",".tag-editor-tag",function(t){if(p.clickDelete&&(t.ctrlKey||1<t.which))return!1;if(!m(this).hasClass("active")){var e=m(this).text(),i=Math.abs((m(this).offset().left-t.pageX)/m(this).width()),a=parseInt(e.length*i),n=m(this).html('<input type="text" maxlength="'+p.maxLength+'" value="'+h(e)+'">').addClass("active").find("input");if(n.data("old_tag",e).tagEditorInput().focus().caret(a),p.autocomplete){var r=m.extend({},p.autocomplete),o="select"in r?p.autocomplete.select:"";r.select=function(t,e){o&&o(t,e),setTimeout(function(){g.trigger("click",[m(".active",g).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},n.autocomplete(r)}}return!1}),g.on("blur","input",function(t){t.stopPropagation();var e=m(this),i=e.data("old_tag"),a=m.trim(e.val().replace(/ +/," ").replace(p.dregex,p.delimiter[0]));if(a){if(0<=a.indexOf(p.delimiter[0]))return void r(e);if(a!=i)if(p.forceLowercase&&(a=a.toLowerCase()),cb_val=p.beforeTagSave(s,g,d,i,a),a=cb_val||a,!1===cb_val){if(i)return e.val(i).focus(),v=!1,void c();try{e.closest("li").remove()}catch(t){}i&&c()}else p.removeDuplicates&&m(".tag-editor-tag:not(.active)",g).each(function(){m(this).text()==a&&m(this).closest("li").remove()})}else{if(i&&!1===p.beforeTagDelete(s,g,d,i))return e.val(i).focus(),v=!1,void c();try{e.closest("li").remove()}catch(t){}i&&c()}e.parent().html(h(a)).removeClass("active"),a!=i&&c(),n()}),g.on("paste","input",function(){m(this).removeAttr("maxlength"),t=m(this),setTimeout(function(){r(t)},30)}),g.on("keypress","input",function(t){0<=p.delimiter.indexOf(String.fromCharCode(t.which))&&(e=m(this),setTimeout(function(){r(e)},20))}),g.on("keydown","input",function(t){var e=m(this);if((37==t.which||!p.autocomplete&&38==t.which)&&!e.caret()||8==t.which&&!e.val())return(i=e.closest("li").prev("li").find(".tag-editor-tag")).length?i.click().find("input").caret(-1):!e.val()||p.maxTags&&g.data("tags").length>=p.maxTags||m(f).insertBefore(e.closest("li")).find(".tag-editor-tag").click(),!1;if((39==t.which||!p.autocomplete&&40==t.which)&&e.caret()==e.val().length)return(a=e.closest("li").next("li").find(".tag-editor-tag")).length?a.click().find("input").caret(0):e.val()&&g.click(),!1;if(9==t.which){if(t.shiftKey){var i;if((i=e.closest("li").prev("li").find(".tag-editor-tag")).length)i.click().find("input").caret(0);else{if(!e.val()||p.maxTags&&g.data("tags").length>=p.maxTags)return s.attr("disabled","disabled"),void setTimeout(function(){s.removeAttr("disabled")},30);m(f).insertBefore(e.closest("li")).find(".tag-editor-tag").click()}return!1}var a;if((a=e.closest("li").next("li").find(".tag-editor-tag")).length)a.click().find("input").caret(0);else{if(!e.val())return;g.click()}return!1}if(!(46!=t.which||m.trim(e.val())&&e.caret()!=e.val().length))return(a=e.closest("li").next("li").find(".tag-editor-tag")).length?a.click().find("input").caret(0):e.val()&&g.click(),!1;if(13==t.which)return g.trigger("click",[e.closest("li").next("li").find(".tag-editor-tag")]),p.maxTags&&g.data("tags").length>=p.maxTags&&g.find("input").blur(),!1;if(36!=t.which||e.caret()){if(35==t.which&&e.caret()==e.val().length)g.find(".tag-editor-tag").last().click();else if(27==t.which)return e.val(e.data("old_tag")?e.data("old_tag"):"").blur(),!1}else g.find(".tag-editor-tag").first().click()});for(var i=p.initialTags.length?p.initialTags:s.val().split(p.dregex),a=0;a<i.length&&!(p.maxTags&&a>=p.maxTags);a++){var u=m.trim(i[a].replace(/ +/," "));u&&(p.forceLowercase&&(u=u.toLowerCase()),d.push(u),g.append('<li><div class="tag-editor-spacer">&nbsp;'+p.delimiter[0]+'</div><div class="tag-editor-tag">'+h(u)+'</div><div class="tag-editor-delete"><i></i></div></li>'))}c(!0),p.sortable&&m.fn.sortable&&g.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){c()}})});var o=[];return this.each(function(){var t=m(this),e=t.data("options"),i=t.next(".tag-editor");if("getTags"==a)o.push({field:t[0],editor:i,tags:i.data("tags")});else if("addTag"==a){if(e.maxTags&&i.data("tags").length>=e.maxTags)return!1;m('<li><div class="tag-editor-spacer">&nbsp;'+e.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(i).find(".tag-editor-tag").html('<input type="text" maxlength="'+e.maxLength+'">').addClass("active").find("input").val(n).blur(),r?m(".placeholder",i).remove():i.click()}else"removeTag"==a?(m(".tag-editor-tag",i).filter(function(){return m(this).text()==n}).closest("li").find(".tag-editor-delete").click(),r||i.click()):"destroy"==a&&t.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==a?o:this},m.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery),function(t,e,i,a){"use strict";t(i).ready(function(){t(".tag-editor").each(function(){t(this).tagEditor({maxTags:t(this).data("maxTags"),autocomplete:{source:e.tag_search_url,minLength:3}})})})}(jQuery,window,document);